<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroMycelix Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        /* --- CSS UTAMA --- */
        :root { --primary: #4facfe; --secondary: #00f2fe; --bg: #1a1a1a; --card: rgba(255,255,255,0.05); }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0c0c0c, #1a1a1a, #2d2d2d);
            color: #e0e0e0; margin: 0; min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        .header {
            text-align: center; padding: 20px; margin-bottom: 20px;
            background: var(--card); border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        h1 { margin: 0; background: linear-gradient(45deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* STATUS & CONTROL */
        .control-panel {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); padding: 15px 25px; border-radius: 15px;
            margin-bottom: 30px; flex-wrap: wrap; gap: 15px;
        }
        .connection-status { display: flex; align-items: center; gap: 10px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #ff4444; box-shadow: 0 0 10px #ff4444; }
        .dot.connected { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        
        /* TOGGLE SWITCH RELAY */
        .relay-wrapper { display: flex; align-items: center; gap: 15px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
        .relay-label { font-weight: bold; color: #fff; }

        /* SENSOR CARDS */
        .sensors-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .sensor-card {
            background: var(--card); border-radius: 20px; padding: 20px;
            border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden;
        }
        .sensor-card:hover { transform: translateY(-5px); border-color: var(--primary); transition: 0.3s; }
        .card-title { color: var(--primary); font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; }
        
        .readings { display: flex; justify-content: space-around; text-align: center; }
        .val-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; width: 45%; }
        .label { font-size: 0.8rem; color: #aaa; }
        .value { font-size: 1.8rem; font-weight: bold; margin: 5px 0; }
        .unit { font-size: 0.8rem; }
        .temp .value { color: #ff6b6b; }
        .hum .value { color: #4ecdc4; }

        /* CHARTS */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-box { background: var(--card); border-radius: 20px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); height: 350px; }

        @media (max-width: 768px) { .control-panel { justify-content: center; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üå± AgroMycelix Dashboard</h1>
        <p>Monitoring & Control System (ESP32 via HiveMQ)</p>
    </div>

    <div class="control-panel">
        <div class="connection-status">
            <div class="dot" id="mqttDot"></div>
            <span id="mqttText">Disconnected</span>
        </div>

        <div class="relay-wrapper">
            <span class="relay-label">KONTROL RELAY:</span>
            <label class="switch">
                <input type="checkbox" id="relayToggle" onclick="toggleRelay()">
                <span class="slider"></span>
            </label>
            <span id="relayStatusText" style="font-size:0.9rem; color:#aaa;">OFF</span>
        </div>
        
        <div style="font-size: 0.9rem; color: #aaa;">
            Update: <span id="lastUpdate">--:--:--</span>
        </div>
    </div>

    <div class="sensors-grid">
        <div class="sensor-card">
            <div class="card-title">üå°Ô∏è Sensor 1 (Pin 15)</div>
            <div class="readings">
                <div class="val-box temp">
                    <div class="label">SUHU</div>
                    <div class="value" id="t1">--</div>
                    <div class="unit">¬∞C</div>
                </div>
                <div class="val-box hum">
                    <div class="label">KELEMBABAN</div>
                    <div class="value" id="h1">--</div>
                    <div class="unit">%</div>
                </div>
            </div>
        </div>
        <div class="sensor-card">
            <div class="card-title">üå°Ô∏è Sensor 2 (Pin 17)</div>
            <div class="readings">
                <div class="val-box temp">
                    <div class="label">SUHU</div>
                    <div class="value" id="t2">--</div>
                    <div class="unit">¬∞C</div>
                </div>
                <div class="val-box hum">
                    <div class="label">KELEMBABAN</div>
                    <div class="value" id="h2">--</div>
                    <div class="unit">%</div>
                </div>
            </div>
        </div>
        <div class="sensor-card">
            <div class="card-title">üå°Ô∏è Sensor 3 (Pin 5)</div>
            <div class="readings">
                <div class="val-box temp">
                    <div class="label">SUHU</div>
                    <div class="value" id="t3">--</div>
                    <div class="unit">¬∞C</div>
                </div>
                <div class="val-box hum">
                    <div class="label">KELEMBABAN</div>
                    <div class="value" id="h3">--</div>
                    <div class="unit">%</div>
                </div>
            </div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-box">
            <canvas id="tempChart"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="humChart"></canvas>
        </div>
    </div>
</div>

<script>
    // --- KONFIGURASI MQTT ---
    // Gunakan port 8884 untuk WebSocket Secure (WSS) pada HiveMQ Cloud
    const brokerUrl = 'wss://43f408e8f8964b6c892c03c6cae2f758.s1.eu.hivemq.cloud:8884/mqtt';
    const options = {
        username: 'hivemq.webclient.1750684556180',
        password: 'w<Td2lKSY1D3>hr.G8s#',
        keepalive: 60,
        clientId: 'WebClient_' + Math.random().toString(16).substr(2, 8) // ClientID acak agar tidak konflik dengan ESP32
    };

    const topicSensors = "dht22/all_sensors";
    const topicRelay = "dht22/relay/control";
    let client;

    // --- SETUP CHART.JS ---
    const maxDataPoints = 20;
    const labels = [];
    
    // Dataset Setup
    const createDataset = (label, color) => ({
        label: label,
        borderColor: color,
        backgroundColor: color + '20', // transparan
        borderWidth: 2,
        tension: 0.4,
        data: []
    });

    const tempData = { labels: labels, datasets: [
        createDataset('S1', '#ff6b6b'), createDataset('S2', '#ff9f43'), createDataset('S3', '#ff6348')
    ]};
    
    const humData = { labels: labels, datasets: [
        createDataset('S1', '#4ecdc4'), createDataset('S2', '#00d2d3'), createDataset('S3', '#2bcbba')
    ]};

    const chartConfig = (data, title) => ({
        type: 'line', data: data,
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#fff' } }, title: { display: true, text: title, color: '#fff' } },
            scales: { x: { ticks: { color: '#888' } }, y: { ticks: { color: '#888' }, grid: { color: '#333' } } }
        }
    });

    const tempChart = new Chart(document.getElementById('tempChart'), chartConfig(tempData, 'Grafik Suhu (¬∞C)'));
    const humChart = new Chart(document.getElementById('humChart'), chartConfig(humData, 'Grafik Kelembaban (%)'));

    // --- FUNGSI MQTT ---
    function connectMQTT() {
        console.log("Menghubungkan ke MQTT...");
        client = mqtt.connect(brokerUrl, options);

        client.on('connect', () => {
            console.log("Terhubung ke HiveMQ!");
            document.getElementById('mqttDot').classList.add('connected');
            document.getElementById('mqttText').textContent = "Connected";
            
            // Subscribe ke topik sensor
            client.subscribe(topicSensors);
        });

        client.on('message', (topic, message) => {
            if (topic === topicSensors) {
                handleSensorMessage(message.toString());
            }
        });

        client.on('close', () => {
            document.getElementById('mqttDot').classList.remove('connected');
            document.getElementById('mqttText').textContent = "Disconnected";
        });
    }

    // --- LOGIKA PARSING DATA JSON DARI ESP32 ---
    function handleSensorMessage(msgJson) {
        try {
            const data = JSON.parse(msgJson);
            const timeStr = new Date().toLocaleTimeString();
            document.getElementById('lastUpdate').textContent = timeStr;

            // Update Chart Label
            if (labels.length > maxDataPoints) labels.shift();
            labels.push(timeStr);

            // Loop data sensors array
            if (data.sensors && Array.isArray(data.sensors)) {
                data.sensors.forEach(s => {
                    const idx = s.id - 1; // array index 0,1,2
                    
                    // Update Angka di Web
                    if (s.temp !== "null") {
                        document.getElementById(`t${s.id}`).textContent = s.temp;
                        document.getElementById(`h${s.id}`).textContent = s.hum;

                        // Update Chart Data
                        const tDs = tempData.datasets[idx].data;
                        const hDs = humData.datasets[idx].data;
                        
                        if (tDs.length > maxDataPoints) tDs.shift();
                        if (hDs.length > maxDataPoints) hDs.shift();
                        
                        tDs.push(s.temp);
                        hDs.push(s.hum);
                    }
                });
            }

            tempChart.update();
            humChart.update();

        } catch (e) {
            console.error("Error parsing JSON:", e);
        }
    }

    // --- LOGIKA KONTROL RELAY ---
    function toggleRelay() {
        const checkBox = document.getElementById("relayToggle");
        const statusText = document.getElementById("relayStatusText");
        
        if (!client || !client.connected) {
            alert("MQTT belum terhubung!");
            checkBox.checked = !checkBox.checked; // Kembalikan posisi switch
            return;
        }

        const payload = checkBox.checked ? "ON" : "OFF";
        client.publish(topicRelay, payload);
        
        statusText.textContent = payload;
        console.log("Kirim perintah Relay:", payload);
    }

    // Jalankan koneksi saat web dibuka
    window.onload = connectMQTT;

</script>
</body>
</html>
